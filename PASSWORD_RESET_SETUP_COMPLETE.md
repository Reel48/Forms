# Password Reset Setup Complete ✅

## Summary

The password reset functionality has been fully set up and is now working. Users can now reset their passwords via email links.

## What Was Fixed

### 1. Database Migration
- **Issue**: The `password_reset_tokens` table was missing from the database
- **Fix**: Applied migration to create the table with proper structure:
  - `id` (UUID, auto-generated)
  - `user_id` (UUID, references auth.users)
  - `token` (VARCHAR, unique)
  - `expires_at` (TIMESTAMP WITH TIME ZONE)
  - `used` (BOOLEAN, default false)
  - `created_at` (TIMESTAMP WITH TIME ZONE, auto-generated)
- **Status**: ✅ Migration applied successfully

### 2. Token Insertion Fix
- **Issue**: The password reset request endpoint was trying to insert `id` and `created_at` fields manually, but these are auto-generated by the database
- **Fix**: Removed `id` and `created_at` from the token data insertion
- **Status**: ✅ Fixed in `backend/routers/auth.py`

### 3. Email Integration
- **Status**: ✅ Already working - emails are sent via AWS SES from `noreply@reel48.com`
- **Reset Link Format**: `{FRONTEND_URL}/reset-password?token={reset_token}`
- **Expiration**: Tokens expire after 1 hour

## How It Works

### 1. User Requests Password Reset
- User goes to `/forgot-password` page
- Enters their email address
- Backend endpoint: `POST /api/auth/password-reset/request`
- System:
  - Finds user by email (if exists)
  - Generates secure token (32 characters, URL-safe)
  - Stores token in `password_reset_tokens` table with 1-hour expiration
  - Sends email with reset link via AWS SES
  - Always returns success (prevents email enumeration)

### 2. User Clicks Reset Link
- User receives email with link: `https://reel48.app/reset-password?token=...`
- Frontend extracts token from URL query parameter
- Displays password reset form

### 3. User Submits New Password
- User enters new password (min 8 characters)
- Confirms password
- Frontend calls: `POST /api/auth/password-reset/confirm`
- Backend:
  - Validates token (exists, not used, not expired)
  - Updates user password via Supabase Auth Admin API
  - Marks token as used
  - Returns success

### 4. User Logs In
- User redirected to login page
- Can now log in with new password

## API Endpoints

### Request Password Reset
```http
POST /api/auth/password-reset/request
Content-Type: application/json

{
  "email": "user@example.com"
}
```

**Response:**
```json
{
  "message": "If an account with that email exists, a password reset link has been sent."
}
```

### Confirm Password Reset
```http
POST /api/auth/password-reset/confirm
Content-Type: application/json

{
  "token": "reset_token_from_email",
  "new_password": "newSecurePassword123"
}
```

**Response:**
```json
{
  "message": "Password reset successfully"
}
```

**Error Responses:**
- `400 Bad Request`: Invalid or expired token
- `500 Internal Server Error`: Server error or configuration issue

## Security Features

1. **Email Enumeration Prevention**: Always returns the same success message, regardless of whether the email exists
2. **Token Expiration**: Tokens expire after 1 hour
3. **One-Time Use**: Tokens are marked as `used` after successful password reset
4. **Secure Token Generation**: Uses `secrets.token_urlsafe(32)` for cryptographically secure tokens
5. **Row Level Security**: `password_reset_tokens` table is protected by RLS, only accessible via service role

## Database Schema

```sql
CREATE TABLE password_reset_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  token VARCHAR(255) NOT NULL UNIQUE,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  used BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## Testing

To test the password reset flow:

1. **Request Reset**:
   ```bash
   curl -X POST https://uvpc5mx3se.us-east-1.awsapprunner.com/api/auth/password-reset/request \
     -H "Content-Type: application/json" \
     -d '{"email": "your-email@example.com"}'
   ```

2. **Check Email**: Look for password reset email from `noreply@reel48.com`

3. **Extract Token**: Copy the token from the reset link

4. **Confirm Reset**:
   ```bash
   curl -X POST https://uvpc5mx3se.us-east-1.awsapprunner.com/api/auth/password-reset/confirm \
     -H "Content-Type: application/json" \
     -d '{"token": "your-token-here", "new_password": "NewPassword123"}'
   ```

5. **Login**: Try logging in with the new password

## Frontend Pages

- **Forgot Password**: `/forgot-password` - Request password reset
- **Reset Password**: `/reset-password?token=...` - Enter new password

## Status

✅ **Password reset is fully functional!**

Users can now:
- Request password resets via email
- Receive reset links via AWS SES
- Reset their passwords using secure tokens
- Log in with their new passwords

## Next Steps (Optional)

1. **Token Cleanup**: Set up a scheduled job to clean up expired tokens using the `cleanup_expired_reset_tokens()` function
2. **Rate Limiting**: Consider adding rate limiting to prevent abuse
3. **Password Strength**: Add more password validation rules if needed
4. **Email Templates**: Customize email templates to match your brand



